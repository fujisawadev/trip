<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex">
    <title>{% if is_edit %}スポットを編集 - {{ spot.name }}{% else %}新規スポット登録{% endif %} | Spacey</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/diamond.svg') }}">
    <!-- <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}"> -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <!-- Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-control-geocoder/2.4.0/Control.Geocoder.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-control-geocoder/2.4.0/Control.Geocoder.js"></script>
    <style>
      /* 地図のスタイル */
      #location-map {
        width: 100%;
        height: 250px;
        border-radius: 0.75rem;
      }
      
      /* オートコンプリート用のスタイル */
      .autocomplete-container {
        position: relative;
      }
      
      .autocomplete-results {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 0.75rem;
        margin-top: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      
      .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      .autocomplete-item:hover {
        background-color: #f3f4f6;
      }
      
      .hidden {
        display: none;
      }
      
      .loading-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
      }
      
      @keyframes spin {
        0% { transform: translateY(-50%) rotate(0deg); }
        100% { transform: translateY(-50%) rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- スポットデータをdata属性として埋め込む -->
    <div id="spot-data" 
      data-is-edit="{% if is_edit %}true{% else %}false{% endif %}"
      data-latitude="{% if is_edit and spot.latitude %}{{ spot.latitude }}{% endif %}"
      data-longitude="{% if is_edit and spot.longitude %}{{ spot.longitude }}{% endif %}">
    </div>
    
    <div class="mx-auto w-full bg-white max-w-[480px]">
      <div class="overflow-hidden w-full bg-slate-50 min-h-[844px]">
        <!-- フラッシュメッセージ -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="px-4 py-2 mb-4 {% if category == 'danger' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
        
        <!-- Top Navigation -->
        <nav
          class="flex justify-between items-center px-4 pt-4 pb-2 w-full bg-slate-50"
        >
          <a
            href="{{ url_for('profile.mypage') }}"
            class="flex items-center self-stretch my-auto w-12 min-h-12"
            aria-label="Back"
          >
            <img
              src="https://cdn.builder.io/api/v1/image/assets/b8fa2d7a435f48ebab0c12e03b54941b/cbcfb374e6f9cf26c845989c39cf840095e94415ef262142766df01f141cd5e1?placeholderIfAbsent=true"
              alt="Back"
              class="object-contain self-stretch my-auto w-6 aspect-square"
            />
          </a>
          <h1
            class="flex-1 shrink self-stretch pr-12 my-auto text-lg font-bold leading-none text-center basis-0 min-w-60 text-neutral-900"
          >
            {% if is_edit %}スポットを編集{% else %}新規スポット登録{% endif %}
          </h1>
          {% if is_edit %}
          <button
            type="button"
            id="delete-spot-btn"
            class="flex items-center justify-center w-12 h-12 text-red-500 hover:text-red-600"
            aria-label="Delete spot"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
            </svg>
          </button>
          {% endif %}
        </nav>

        <!-- Spot Form -->
        <form 
          action="{% if is_edit %}{{ url_for('spot.edit_spot', spot_id=spot.id) }}{% else %}{{ url_for('spot.add_spot') }}{% endif %}" 
          method="POST" 
          enctype="multipart/form-data"
          class="flex flex-col gap-6 p-4 w-full"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <!-- 緯度経度の隠しフィールド -->
          <input type="hidden" id="latitude" name="latitude" value="{% if is_edit %}{{ spot.latitude or '' }}{% endif %}">
          <input type="hidden" id="longitude" name="longitude" value="{% if is_edit %}{{ spot.longitude or '' }}{% endif %}">
          <input type="hidden" id="google_place_id" name="google_place_id" value="{% if is_edit %}{{ spot.google_place_id or '' }}{% endif %}">
          <input type="hidden" id="formatted_address" name="formatted_address" value="{% if is_edit %}{{ spot.formatted_address or '' }}{% endif %}">
          <input type="hidden" id="types" name="types" value="{% if is_edit %}{{ spot.types or '' }}{% endif %}">
          <input type="hidden" id="thumbnail_url" name="thumbnail_url" value="{% if is_edit %}{{ spot.thumbnail_url or '' }}{% endif %}">
          <input type="hidden" id="google_photo_reference" name="google_photo_reference" value="{% if is_edit %}{{ spot.google_photo_reference or '' }}{% endif %}">
          <input type="hidden" id="summary_location" name="summary_location" value="{% if is_edit %}{{ spot.summary_location or '' }}{% endif %}">
          
          <!-- Spot Name -->
          <div class="flex flex-col gap-2 w-full">
            <label for="spotName" class="text-sm font-bold text-neutral-900">スポット名</label>
            <div class="autocomplete-container">
              <input
                type="text"
                id="spotName"
                name="spotName"
                required
                value="{% if is_edit %}{{ spot.name }}{% endif %}"
                placeholder="スポット名を入力"
                class="px-4 py-3 w-full text-base bg-white rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                autocomplete="off"
              />
              <div id="loading-indicator" class="loading-indicator hidden"></div>
              <div id="autocomplete-results" class="autocomplete-results hidden"></div>
            </div>
          </div>

          <!-- Spot Location -->
          <div class="flex flex-col gap-2 w-full">
            <label for="location" class="text-sm font-bold text-neutral-900">場所</label>
            <input
              type="text"
              id="location"
              name="location"
              value="{% if is_edit %}{{ spot.location }}{% endif %}"
              placeholder="場所を入力"
              class="px-4 py-3 w-full text-base bg-white rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button 
              type="button" 
              id="search-location" 
              class="px-4 py-2 mt-1 text-sm font-medium text-white bg-blue-500 rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              場所を検索
            </button>
          </div>

          <!-- Location Map -->
          <div class="flex flex-col gap-2 w-full">
            <label class="text-sm font-bold text-neutral-900">地図上の位置</label>
            <p class="text-xs text-slate-500 mb-2">地図をクリックして位置を設定するか、マーカーをドラッグして位置を調整してください。</p>
            <div id="location-map" class="w-full rounded-xl"></div>
          </div>

          <!-- Spot Category -->
          <div class="flex flex-col gap-2 w-full">
            <label for="category" class="text-sm font-bold text-neutral-900">カテゴリー</label>
            <div class="autocomplete-container relative" style="z-index: 9999;">
              <input
                type="text"
                id="category"
                name="category"
                value="{% if is_edit %}{{ spot.category }}{% endif %}"
                placeholder="カテゴリーを入力または選択"
                class="px-4 py-3 w-full text-base bg-white rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                autocomplete="off"
              />
              <div id="category-loading-indicator" class="loading-indicator hidden"></div>
              <div id="category-autocomplete-results" class="autocomplete-results hidden absolute z-[9999] w-full bg-white border border-gray-200 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto"></div>
            </div>
            <p class="text-xs text-slate-500">新しいカテゴリーを入力するか、過去のカテゴリーから選択してください</p>
          </div>

          <!-- Spot Description -->
          <div class="flex flex-col gap-2 w-full">
            <label for="description" class="text-sm font-bold text-neutral-900">説明</label>
            <textarea
              id="description"
              name="description"
              rows="4"
              placeholder="スポットの説明を入力"
              class="px-4 py-3 w-full text-base bg-white rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >{% if is_edit %}{{ spot.description }}{% endif %}</textarea>
          </div>

          <!-- Current Photos -->
          {% if is_edit and spot.photos and spot.photos|length > 0 %}
          <div class="flex flex-col gap-2 w-full">
            <label class="text-sm font-bold text-neutral-900">現在の写真</label>
            <div class="flex flex-wrap gap-2 w-full">
              {% for photo in spot.photos %}
                <div class="preview-item">
                  <img
                    src="{{ photo.photo_url }}"
                    alt="スポット写真"
                    class="w-full h-full object-cover rounded-lg"
                  />
                  <div class="remove-btn" data-photo-id="{{ photo.id }}">×</div>
                  <input type="hidden" name="existing_photos" value="{{ photo.id }}">
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Spot Photos -->
          <div class="flex flex-col gap-2 w-full">
            <label class="text-sm font-bold text-neutral-900">{% if is_edit %}新しい写真を追加{% else %}写真{% endif %}</label>
            <div class="flex flex-col gap-3 w-full">
              <div class="relative">
                <input
                  type="file"
                  id="photos"
                  name="photos"
                  multiple
                  accept="image/*"
                  class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                />
                <div
                  class="flex justify-center items-center px-4 py-3 w-full bg-white rounded-xl border border-dashed border-slate-300 min-h-[100px]"
                  id="drop-area"
                >
                  <div class="flex flex-col items-center text-center">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-8 h-8 text-slate-400 mb-2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
                      />
                    </svg>
                    <p class="text-sm text-slate-500">
                      写真をドラッグ＆ドロップまたは<span class="text-blue-500">ファイルを選択</span>
                    </p>
                  </div>
                </div>
              </div>
              <div
                id="preview-container"
                class="flex flex-wrap gap-2 w-full"
              ></div>
            </div>
          </div>

          <!-- Active Status -->
          <div class="flex justify-between items-center w-full">
            <span class="text-base font-bold text-neutral-900">公開状態</span>
            <label
              class="flex p-0.5 rounded-2xl bg-slate-200 min-h-[31px] w-[51px] cursor-pointer"
              role="switch"
            >
              <input type="checkbox" name="is_active" class="toggle-switch sr-only" {% if not is_edit or (is_edit and spot.is_active) %}checked{% endif %} />
              <span
                class="toggle-slider flex bg-white rounded-2xl h-[27px] min-h-[27px] shadow-[0px_3px_8px_rgba(0,0,0,0.15)] w-[27px] transition-transform duration-200"
              ></span>
            </label>
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="flex justify-center items-center px-4 w-full bg-blue-500 text-white rounded-xl min-h-12 mt-4"
          >
            <span class="text-base font-medium">{% if is_edit %}変更を保存{% else %}スポットを登録{% endif %}</span>
          </button>
        </form>
      </div>
    </div>

    <style>
      .toggle-switch:checked + .toggle-slider {
        transform: translateX(20px);
      }
      .preview-item {
        position: relative;
        width: 80px;
        height: 80px;
      }
      .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      .remove-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
      }
      /* モーダル表示時のスタイル */
      body.modal-open {
        overflow: hidden;
      }
      
      body.modal-open .leaflet-container {
        z-index: 1 !important;
      }
      
      body.modal-open .autocomplete-container {
        z-index: 1 !important;
      }
      
      .autocomplete-container {
        position: relative;
        z-index: 1000;
      }
      
      #location-map {
        z-index: 1;
      }
    </style>

    <!-- 地図ユーティリティJSの読み込み -->
    <script src="{{ url_for('static', filename='js/map-utils.js') }}"></script>

    <!-- 削除確認モーダル -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[10000]">
      <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-bold text-neutral-900 mb-4">スポットを削除</h3>
        <p class="text-neutral-600 mb-6">このスポットを削除してもよろしいですか？この操作は取り消せません。</p>
        <div class="flex justify-end gap-4">
          <button
            type="button"
            id="cancel-delete-btn"
            class="px-4 py-2 text-neutral-600 hover:bg-neutral-100 rounded-lg"
          >
            キャンセル
          </button>
          <form
            action="{{ url_for('spot.delete_spot', spot_id=spot.id) if is_edit else '#' }}"
            method="POST"
            id="delete-spot-form"
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button
              type="submit"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
            >
              削除する
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // グローバルエラーハンドリング
      window.addEventListener('error', function(event) {
        console.error('Global error caught:', event.error);
        alert('ページの読み込み中にエラーが発生しました。ページをリロードしてください。');
      });

      // 外部リソースの読み込みエラーを検知
      window.addEventListener('load', function() {
        const scripts = document.getElementsByTagName('script');
        for (let i = 0; i < scripts.length; i++) {
          if (!scripts[i].loaded && scripts[i].src) {
            console.warn('Script may not have loaded properly:', scripts[i].src);
          }
        }
      });

      // File upload preview
      const fileInput = document.getElementById('photos');
      const previewContainer = document.getElementById('preview-container');
      const dropArea = document.getElementById('drop-area');
      
      // Handle file selection
      fileInput.addEventListener('change', handleFiles);
      
      // Drag and drop functionality
      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('border-blue-500');
      });
      
      dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('border-blue-500');
      });
      
      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('border-blue-500');
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFiles();
        }
      });
      
      function handleFiles() {
        const files = fileInput.files;
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.startsWith('image/')) continue;
          
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = 'Preview';
            
            const removeBtn = document.createElement('div');
            removeBtn.className = 'remove-btn';
            removeBtn.innerHTML = '×';
            removeBtn.addEventListener('click', function() {
              previewItem.remove();
              // Note: This doesn't actually remove the file from the input
              // In a real app, you'd need to handle this properly
            });
            
            previewItem.appendChild(img);
            previewItem.appendChild(removeBtn);
            previewContainer.appendChild(previewItem);
          };
          
          reader.readAsDataURL(file);
        }
      }
      
      // Remove existing photo functionality
      document.querySelectorAll('.remove-btn[data-photo-id]').forEach(btn => {
        btn.addEventListener('click', function() {
          const photoId = this.dataset.photoId;
          const previewItem = this.closest('.preview-item');
          
          // Add a hidden input to mark this photo for deletion
          const deleteInput = document.createElement('input');
          deleteInput.type = 'hidden';
          deleteInput.name = 'delete_photos';
          deleteInput.value = photoId;
          document.querySelector('form').appendChild(deleteInput);
          
          // Hide the preview item
          previewItem.style.display = 'none';
        });
      });

      // Google Places Autocomplete
      document.addEventListener('DOMContentLoaded', function() {
        const spotNameInput = document.getElementById('spotName');
        const autocompleteResults = document.getElementById('autocomplete-results');
        const loadingIndicator = document.getElementById('loading-indicator');
        const locationInput = document.getElementById('location');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const googlePlaceIdInput = document.getElementById('google_place_id');
        const formattedAddressInput = document.getElementById('formatted_address');
        const typesInput = document.getElementById('types');
        const thumbnailUrlInput = document.getElementById('thumbnail_url');
        const categoryInput = document.getElementById('category');
        
        let debounceTimer;
        
        // 入力イベントのハンドリング
        spotNameInput.addEventListener('input', function() {
          const query = this.value.trim();
          
          // 3文字未満の場合は候補表示しない
          if (query.length < 3) {
            autocompleteResults.classList.add('hidden');
            return;
          }
          
          // ローディングインジケータを表示
          loadingIndicator.classList.remove('hidden');
          
          // debounce処理（入力が落ち着いてから検索実行）
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            fetchPlaceSuggestions(query);
          }, 300);
        });
        
        // 候補取得関数
        function fetchPlaceSuggestions(query) {
          fetch(`/api/places/autocomplete?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
              // ローディングインジケータを非表示
              loadingIndicator.classList.add('hidden');
              displaySuggestions(data);
            })
            .catch(error => {
              console.error('Error fetching place suggestions:', error);
              // ローディングインジケータを非表示
              loadingIndicator.classList.add('hidden');
            });
        }
        
        // 候補表示関数
        function displaySuggestions(suggestions) {
          autocompleteResults.innerHTML = '';
          
          if (suggestions.length === 0) {
            autocompleteResults.classList.add('hidden');
            return;
          }
          
          suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            
            // メインテキストとセカンダリテキストを表示
            const mainText = document.createElement('div');
            mainText.className = 'font-medium';
            mainText.textContent = suggestion.description;
            
            const secondaryText = document.createElement('div');
            secondaryText.className = 'text-sm text-gray-500';
            secondaryText.textContent = suggestion.secondary_text || '';
            
            item.appendChild(mainText);
            item.appendChild(secondaryText);
            
            item.addEventListener('click', () => {
              selectPlace(suggestion.place_id);
            });
            
            autocompleteResults.appendChild(item);
          });
          
          autocompleteResults.classList.remove('hidden');
        }
        
        // 候補選択関数
        function selectPlace(placeId) {
          // ローディングインジケータを表示
          loadingIndicator.classList.remove('hidden');
          
          fetch(`/api/places/details?place_id=${placeId}`)
            .then(response => response.json())
            .then(data => {
              // ローディングインジケータを非表示
              loadingIndicator.classList.add('hidden');
              
              // フォームに詳細情報を入力
              spotNameInput.value = data.name;
              locationInput.value = data.formatted_address;
              latitudeInput.value = data.latitude;
              longitudeInput.value = data.longitude;
              googlePlaceIdInput.value = data.place_id;
              formattedAddressInput.value = data.formatted_address;
              
              // サマリーロケーションを設定
              if (data.summary_location) {
                document.getElementById('summary_location').value = data.summary_location;
              }
              
              // カテゴリ情報があれば設定
              if (data.types && data.types.length > 0) {
                // typesをJSON文字列として保存
                typesInput.value = JSON.stringify(data.types);
              }
              
              // サムネイル画像URLがあれば設定
              if (data.thumbnail_url) {
                thumbnailUrlInput.value = data.thumbnail_url;
              }
              
              // 写真参照情報があれば設定
              if (data.photo_reference) {
                document.getElementById('google_photo_reference').value = data.photo_reference;
              }
              
              // 地図を更新
              if (window.map && data.latitude && data.longitude) {
                updateMarkerAndInputs(data.latitude, data.longitude);
                window.map.setView([data.latitude, data.longitude], 15);
              }
              
              // 候補リストを非表示
              autocompleteResults.classList.add('hidden');
            })
            .catch(error => {
              console.error('Error fetching place details:', error);
              // ローディングインジケータを非表示
              loadingIndicator.classList.add('hidden');
            });
        }
        
        // クリックイベントのハンドリング（候補リスト以外をクリックしたら候補を非表示）
        document.addEventListener('click', function(e) {
          if (!autocompleteResults.contains(e.target) && e.target !== spotNameInput) {
            autocompleteResults.classList.add('hidden');
          }
        });
      });
      
      // 地図関連の処理
      document.addEventListener('DOMContentLoaded', function() {
        try {
          const locationInput = document.getElementById('location');
          const latitudeInput = document.getElementById('latitude');
          const longitudeInput = document.getElementById('longitude');
          const searchButton = document.getElementById('search-location');
          
          // 初期位置（東京）
          let initialLat = 35.6812;
          let initialLng = 139.7671;
          let initialZoom = 13;
          
          // スポットデータをdata属性から取得
          const spotDataElement = document.getElementById('spot-data');
          const isEdit = spotDataElement.dataset.isEdit === 'true';
          const spotLat = spotDataElement.dataset.latitude ? parseFloat(spotDataElement.dataset.latitude) : null;
          const spotLng = spotDataElement.dataset.longitude ? parseFloat(spotDataElement.dataset.longitude) : null;
          
          // 編集時は既存の位置情報を使用
          if (isEdit && spotLat && spotLng) {
            initialLat = spotLat;
            initialLng = spotLng;
            initialZoom = 15;
          }
          
          console.log('Initializing map...');
          
          // 地図の初期化
          if (typeof initMap === 'function') {
            try {
              window.map = initMap('location-map', {
                center: [initialLat, initialLng],
                zoom: initialZoom
              });
              console.log('Map initialized successfully');
            } catch (mapError) {
              console.error('Failed to initialize map:', mapError);
              return;
            }
            
            // ジオコーディングコントロールを追加
            if (L && L.Control && L.Control.geocoder) {
              L.Control.geocoder({
                defaultMarkGeocode: false
              }).on('markgeocode', function(e) {
                const latlng = e.geocode.center;
                updateMarkerAndInputs(latlng.lat, latlng.lng, e.geocode.name);
                window.map.fitBounds(e.geocode.bbox);
              }).addTo(window.map);
            } else {
              console.error('Leaflet Control Geocoder not loaded');
            }
            
            // マーカーを作成
            let marker = null;
            
            // 編集時は既存の位置情報でマーカーを表示
            if (latitudeInput.value && longitudeInput.value) {
              marker = addMarker(window.map, parseFloat(latitudeInput.value), parseFloat(longitudeInput.value), {
                draggable: true
              });
              
              // マーカードラッグ時の処理
              marker.on('dragend', function(e) {
                const latlng = e.target.getLatLng();
                updateInputs(latlng.lat, latlng.lng);
                
                // 逆ジオコーディングで住所を取得
                reverseGeocode(latlng.lat, latlng.lng).then(result => {
                  if (result) {
                    locationInput.value = result.address;
                    document.getElementById('summary_location').value = result.summary_location;
                  }
                });
              });
            }
            
            // 地図クリック時の処理
            window.map.on('click', function(e) {
              const latlng = e.latlng;
              updateMarkerAndInputs(latlng.lat, latlng.lng);
              
              // 逆ジオコーディングで住所を取得
              reverseGeocode(latlng.lat, latlng.lng).then(result => {
                if (result) {
                  locationInput.value = result.address;
                  document.getElementById('summary_location').value = result.summary_location;
                }
              });
            });
            
            // 検索ボタンクリック時の処理
            searchButton.addEventListener('click', function() {
              const address = locationInput.value;
              if (address) {
                geocodeAddress(address).then(result => {
                  if (result) {
                    updateMarkerAndInputs(result.lat, result.lng, result.displayName);
                    window.map.setView([result.lat, result.lng], 15);
                    
                    // 逆ジオコーディングでサマリーロケーションを取得
                    reverseGeocode(result.lat, result.lng).then(geoResult => {
                      if (geoResult && geoResult.summary_location) {
                        document.getElementById('summary_location').value = geoResult.summary_location;
                      }
                    });
                  } else {
                    alert('場所が見つかりませんでした。別の住所を試してください。');
                  }
                });
              }
            });
            
            // マーカーと入力フィールドを更新する関数
            function updateMarkerAndInputs(lat, lng, address = null) {
              updateInputs(lat, lng);
              
              if (address) {
                locationInput.value = address;
              }
              
              if (marker) {
                marker.setLatLng([lat, lng]);
              } else {
                marker = addMarker(window.map, lat, lng, {
                  draggable: true
                });
                
                // マーカードラッグ時の処理
                marker.on('dragend', function(e) {
                  const latlng = e.target.getLatLng();
                  updateInputs(latlng.lat, latlng.lng);
                  
                  // 逆ジオコーディングで住所を取得
                  reverseGeocode(latlng.lat, latlng.lng).then(result => {
                    if (result) {
                      locationInput.value = result.address;
                      document.getElementById('summary_location').value = result.summary_location;
                    }
                  });
                });
              }
            }
            
            // 入力フィールドを更新する関数
            function updateInputs(lat, lng) {
              latitudeInput.value = lat;
              longitudeInput.value = lng;
            }
          }
        } catch (error) {
          console.error('Error initializing map:', error);
        }
      });

      // カテゴリの自動補完機能
      document.addEventListener('DOMContentLoaded', function() {
        const categoryInput = document.getElementById('category');
        const categoryResults = document.getElementById('category-autocomplete-results');
        const categoryLoadingIndicator = document.getElementById('category-loading-indicator');
        let categories = [];
        
        // カテゴリ一覧を取得
        console.log('Fetching categories...');
        fetch('/api/user/categories')
          .then(response => response.json())
          .then(data => {
            console.log('Received categories:', data);
            categories = data;
            
            // フォーカス時に候補を表示するためのイベントリスナーを追加
            categoryInput.addEventListener('focus', function() {
              console.log('Input focused, current categories:', categories);
              if (categories.length > 0) {
                categoryResults.innerHTML = '';
                
                categories.forEach(category => {
                  const item = document.createElement('div');
                  item.className = 'autocomplete-item';
                  item.textContent = category;
                  
                  item.addEventListener('click', () => {
                    categoryInput.value = category;
                    categoryResults.classList.add('hidden');
                  });
                  
                  categoryResults.appendChild(item);
                });
                
                categoryResults.classList.remove('hidden');
              }
            });
            
            // 入力時の処理
            categoryInput.addEventListener('input', function() {
              const query = this.value.toLowerCase().trim();
              console.log('Input changed:', query);
              
              // 結果をクリア
              categoryResults.innerHTML = '';
              
              if (query.length === 0) {
                categoryResults.classList.add('hidden');
                return;
              }
              
              // 一致するカテゴリを検索
              const matches = categories.filter(category => 
                category.toLowerCase().includes(query)
              );
              console.log('Matching categories:', matches);
              
              if (matches.length === 0) {
                categoryResults.classList.add('hidden');
                return;
              }
              
              // 結果を表示
              matches.forEach(category => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.textContent = category;
                
                item.addEventListener('click', () => {
                  categoryInput.value = category;
                  categoryResults.classList.add('hidden');
                });
                
                categoryResults.appendChild(item);
              });
              
              categoryResults.classList.remove('hidden');
            });
          })
          .catch(error => {
            console.error('Error fetching categories:', error);
            categoryLoadingIndicator.classList.add('hidden');
          });
        
        // クリックイベントのハンドリング（候補リスト以外をクリックしたら候補を非表示）
        document.addEventListener('click', function(e) {
          if (!categoryResults.contains(e.target) && e.target !== categoryInput) {
            categoryResults.classList.add('hidden');
          }
        });
      });

      // 削除機能の実装
      document.addEventListener('DOMContentLoaded', function() {
        const deleteBtn = document.getElementById('delete-spot-btn');
        const modal = document.getElementById('delete-confirm-modal');
        const cancelBtn = document.getElementById('cancel-delete-btn');

        if (deleteBtn) {
          deleteBtn.addEventListener('click', function() {
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          });
        }

        // モーダルの外側をクリックしたときにモーダルを閉じる
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.add('hidden');
            document.body.classList.remove('modal-open');
          }
        });
      });
    </script>
  </body>
</html> 