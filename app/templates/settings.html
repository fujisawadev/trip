{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">アカウント設定</h1>
    
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link {% if tab == 'profile' %}active{% endif %}" id="profile-tab" data-toggle="tab" href="#profile" role="tab">プロフィール</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'instagram' %}active{% endif %}" id="instagram-tab" data-toggle="tab" href="#instagram" role="tab">Instagram連携</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if tab == 'password' %}active{% endif %}" id="password-tab" data-toggle="tab" href="#password" role="tab">パスワード変更</a>
        </li>
    </ul>
    
    <div class="tab-content" id="settingsTabsContent">
        <!-- プロフィール設定タブ -->
        <div class="tab-pane fade {% if tab == 'profile' %}show active{% endif %}" id="profile" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">プロフィール情報</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('profile_blueprint.update_profile') }}" enctype="multipart/form-data">
                        {{ profile_form.csrf_token }}
                        
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">ユーザー名</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="username" value="{{ current_user.username }}" readonly>
                                <small class="form-text text-muted">ユーザー名は変更できません</small>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">表示名</label>
                            <div class="col-sm-9">
                                <input type="text" class="form-control" name="display_name" value="{{ current_user.display_name or '' }}">
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">メールアドレス</label>
                            <div class="col-sm-9">
                                <input type="email" class="form-control" name="email" value="{{ current_user.email }}">
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">自己紹介</label>
                            <div class="col-sm-9">
                                <textarea class="form-control" name="bio" rows="4">{{ current_user.bio or '' }}</textarea>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">プロフィール画像</label>
                            <div class="col-sm-9">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="profile_image" name="profile_image">
                                    <label class="custom-file-label" for="profile_image">画像を選択...</label>
                                </div>
                                {% if current_user.profile_image %}
                                <div class="mt-2">
                                    <img src="{{ current_user.profile_image }}" alt="プロフィール画像" class="img-thumbnail" style="max-width: 100px;">
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="text-right">
                            <button type="submit" class="btn btn-primary">保存する</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Instagram連携タブ -->
        <div class="tab-pane fade {% if tab == 'instagram' %}show active{% endif %}" id="instagram" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Instagram連携設定</h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_instagram_connected() %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle mr-2"></i> Instagramアカウント「{{ current_user.instagram_username }}」と連携中です
                        </div>
                        
                        <!-- 自動返信設定 -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">自動返信設定</h6>
                            </div>
                            <div class="card-body">
                                <form method="POST" action="{{ url_for('profile_blueprint.update_autoreply') }}">
                                    {{ autoreply_form.csrf_token }}
                                    
                                    <div class="form-group">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="autoreply_enabled" name="autoreply_enabled" {% if current_user.autoreply_enabled %}checked{% endif %}>
                                            <label class="custom-control-label" for="autoreply_enabled">Instagram DMの自動返信を有効にする</label>
                                        </div>
                                        <small class="form-text text-muted">場所に関する質問に自動的に返信します</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>自動返信テンプレート</label>
                                        <textarea class="form-control" name="autoreply_template" rows="4">{{ current_user.autoreply_template or 'ご質問ありがとうございます。より詳しい情報は私のプロフィールをご覧ください: {profile_url}' }}</textarea>
                                        <small class="form-text text-muted">
                                            使用できる変数: <code>{profile_url}</code> - あなたのプロフィールURL
                                        </small>
                                    </div>
                                    
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-primary">自動返信設定を保存</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Instagram連携解除 -->
                        <form method="POST" action="{{ url_for('profile_blueprint.disconnect_instagram') }}" onsubmit="return confirm('Instagramの連携を解除しますか？自動返信機能が使えなくなります。');">
                            {{ disconnect_form.csrf_token }}
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-unlink mr-1"></i> Instagram連携を解除する
                            </button>
                        </form>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle mr-2"></i> Instagramプロフェッショナルアカウント（ビジネスまたはクリエイターアカウント）と連携すると、DMへの自動返信機能が利用できます。
                        </div>
                        
                        <div class="text-center my-4">
                            <a href="{{ url_for('profile_blueprint.connect_instagram') }}" class="btn btn-primary btn-lg">
                                <i class="fab fa-instagram mr-2"></i> Instagramと連携する
                            </a>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Instagram連携の手順</h6>
                            </div>
                            <div class="card-body">
                                <ol>
                                    <li class="mb-2">Instagramのプロフェッショナルアカウント（ビジネスまたはクリエイターアカウント）を用意してください。</li>
                                    <li class="mb-2">「Instagramと連携する」ボタンをクリックして、Instagramにログインします。</li>
                                    <li class="mb-2">アクセス許可を求められたら「許可する」を選択してください。</li>
                                    <li>連携が完了すると、DMへの自動返信機能が利用できるようになります。</li>
                                </ol>
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-exclamation-triangle mr-2"></i> 個人アカウントではなく、ビジネスまたはクリエイターアカウントである必要があります。
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- パスワード変更タブ -->
        <div class="tab-pane fade {% if tab == 'password' %}show active{% endif %}" id="password" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">パスワード変更</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('profile_blueprint.change_password') }}">
                        {{ password_form.csrf_token }}
                        
                        <div class="form-group">
                            <label>現在のパスワード</label>
                            <input type="password" class="form-control" name="current_password" required>
                        </div>
                        
                        <div class="form-group">
                            <label>新しいパスワード</label>
                            <input type="password" class="form-control" name="new_password" required>
                            <small class="form-text text-muted">8文字以上で設定してください</small>
                        </div>
                        
                        <div class="form-group">
                            <label>新しいパスワード（確認）</label>
                            <input type="password" class="form-control" name="confirm_password" required>
                        </div>
                        
                        <div class="text-right">
                            <button type="submit" class="btn btn-primary">パスワードを変更</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
