<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8YNG8DGYKZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8YNG8DGYKZ');
    </script>
    
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    
    <!-- ÂãïÁöÑ„É°„Çø„Çø„Ç∞Ë®≠ÂÆö -->
    <meta name="description" content="{{ spot.description or (spot.name + '„ÅÆË©≥Á¥∞ÊÉÖÂ†±') }}">
    <title>{{ spot.name }} | {{ user.username }} | maplink</title>
    
    <!-- OGPË®≠ÂÆö -->
    <meta property="og:title" content="{{ spot.name }} | {{ user.username }}">
    <meta property="og:description" content="{{ spot.description or (spot.name + ' - ' + (spot.location or '')) }}">
    {% if photos and photos|length > 0 %}
    <meta property="og:image" content="{{ photos[0] }}">
    {% else %}
    <meta property="og:image" content="{{ url_for('static', filename='images/ogp.png', _external=True) }}">
    {% endif %}
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">
    
    <!-- Twitter CardË®≠ÂÆö -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ spot.name }} | {{ user.username }}">
    <meta name="twitter:description" content="{{ spot.description or (spot.name + ' - ' + (spot.location or '')) }}">
    {% if photos and photos|length > 0 %}
    <meta name="twitter:image" content="{{ photos[0] }}">
    {% else %}
    <meta name="twitter:image" content="{{ url_for('static', filename='images/ogp.png', _external=True) }}">
    {% endif %}
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon_32x32.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    
    <!-- ÂøÖË¶Å„Å™„É©„Ç§„Éñ„É©„É™„ÇíÂÄãÂà•Ë™≠„ÅøËæº„Åø -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    
    <!-- marked.js „ÅÆË™≠„ÅøËæº„Åø -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- FOUCÈò≤Ê≠¢Ôºö„Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„ÅßÂç≥Â∫ß„Å´ÈùûË°®Á§∫ -->
    <style>
        .no-fouc { display: none; }
    </style>
    <script>
        document.documentElement.className = 'no-fouc';
    </script>
    
    <style type="text/tailwindcss">
        :root {
          --primary-color: #2563EB;
          --secondary-color: #F3F4F6;
          --accent-color: #F59E0B;
          --text-primary: #111827;
          --text-secondary: #4B5563;
          --background-color: #FFFFFF;
          --card-background: #F9FAFB;
          --border-color: #E5E7EB;
          --hover-bg-color: #EFF6FF;
        }
        
        body {
          font-family: 'Noto Sans JP', sans-serif;
          margin: 0;
          padding: 0;
          background: #F8F9FA;
        }
        
        /* ÈÄöÂ∏∏„ÅÆ„Éö„Éº„Ç∏Ë°®Á§∫ */
        .spot-detail-page {
            min-height: 100vh;
            width: 100%;
            background: #F8F9FA;
        }
        
        .spot-detail-container {
            width: 100%;
            max-width: 28rem;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .spot-detail-container.animate-in {
            transform: translateY(0);
        }
        
        .spot-detail-container.animate-out {
            transform: translateY(100%);
        }
        
        /* „Éò„ÉÉ„ÉÄ„ÉºÂõ∫ÂÆö */
        .spot-header {
            position: relative;
            z-index: 10;
            background: var(--background-color);
            /* border-bottom „ÅØÊñ∞„Åó„ÅÑ„ÇØ„É©„Çπ„ÅßÁÆ°ÁêÜ */
        }
        
        /* „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç®„É™„Ç¢ */
        .spot-content {
            flex: 1;
            overflow-y: auto;
            background: var(--background-color);
        }
        
        /* Âú∞Âõ≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        #spot-map {
            width: 100%;
            height: 250px;
            border-radius: 0.75rem;
        }
        
        /* Êàª„Çã„Éú„Çø„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .back-button {
            transition: transform 0.2s ease;
        }
        
        .back-button:hover {
            transform: scale(1.1);
        }
        
        /* ÂêÑ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        /* ÂÜôÁúü„ÇÆ„É£„É©„É™„Éº */
        .photo-gallery {
            display: flex;
            gap: 0.5rem; /* ÂÜôÁúüÈñì„ÅÆÈöôÈñì„ÇíËøΩÂä† (8px) */
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            scroll-snap-type: x mandatory; /* Ê®™ÊñπÂêë„ÅÆ„Çπ„Éä„ÉÉ„Éó„Çπ„ÇØ„É≠„Éº„É´„ÇíÊúâÂäπÂåñ */
        }
        .photo-gallery::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        
        .photo-gallery img {
            width: 100%; /* „Ç≥„É≥„ÉÜ„Éä„ÅÆÂπÖ„ÅÑ„Å£„Å±„ÅÑ„Å´Ë°®Á§∫ */
            height: 100%;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 0.75rem; /* Ëßí‰∏∏„ÇíÈÅ©Áî® */
            scroll-snap-align: start; /* ÂêÑÁîªÂÉè„ÅÆÂÖàÈ†≠„Åß„Çπ„Éä„ÉÉ„Éó */
        }
        
        /* --- „Ç´„É´„Éº„Çª„É´„ÅÆ„Éâ„ÉÉ„Éà„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº --- */
        .photo-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.2s ease;
        }
        .dot.active {
            background-color: var(--primary-color);
        }
        
        /* „É¨„Éì„É•„ÉºË°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´ */
        .review-display {
            display: flex;
            flex-direction: column; /* Á∏¶‰∏¶„Å≥„Å´Â§âÊõ¥ */
            align-items: flex-start; /* Â∑¶ÊèÉ„Åà„Å´Â§âÊõ¥ */
            gap: 0.25rem; /* 4px */
        }
        .review-score {
            font-size: 2.25rem; /* 36px */
            line-height: 2.5rem; /* 40px */
            font-weight: 700;
        }
        .review-stars .material-icons {
            font-size: 1.25rem; /* 20px */
        }

        /* --- SNS„É™„É≥„ÇØ„ÅÆÊñ∞„Åó„ÅÑ„Çπ„Çø„Ç§„É´ --- */
        .sns-links-container {
            display: flex;
            gap: 1rem; /* 16px */
        }
        .sns-link {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 44px;
            height: 44px;
            transition: all 0.2s ease;
        }
        .sns-link-active:hover {
            transform: scale(1.1);
        }
        .sns-link-active img {
            width: 28px;
            height: 28px;
        }
        .sns-link-inactive {
            background-color: #F3F4F6; /* ËñÑ„ÅÑ„Ç∞„É¨„Éº„ÅÆËÉåÊôØ */
            border-radius: 50%;
            cursor: default;
        }
        .sns-link-inactive img {
            width: 24px;
            height: 24px;
            filter: grayscale(100%);
            opacity: 0.6; /* ÈÄèÊòéÂ∫¶„ÇíÂ∞ë„Åó‰∏ä„Åí„Çã */
        }

        /* Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™SNS„É™„É≥„ÇØ */
        .sns-link-inactive {
            filter: grayscale(100%);
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* „ÇØ„Ç§„ÉÉ„ÇØ„Éó„É≠„É≥„Éó„Éà„Éú„Çø„É≥ */
        .quick-prompt-btn {
            background-color: #f0f4f8;
            color: #1e3a8a;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .quick-prompt-btn:hover {
            background-color: #e2e8f0;
            color: #1c3473;
        }
        
        /* „ÉÅ„É£„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏ */
        .message {
            padding: 0.75rem 1rem;
            max-width: 85%;
            border-radius: 1.25rem;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .message.user {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
            align-self: flex-end;
        }
        .message.system {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 0.25rem;
            align-self: flex-start;
        }
        
        .shadow-top {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* BioË°®Á§∫Áî®„ÅÆ„Çπ„Çø„Ç§„É´Ôºà„Éó„É≠„Éï„Ç£„Éº„É´„Éö„Éº„Ç∏„Åã„ÇâËøΩÂä†Ôºâ */
        .bio-collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        .bio-expanded {
            line-height: 1.4;
        }
        .bio-toggle-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        /* --- Êñ∞„Åó„ÅÑ„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        .spot-header.fixed-height {
            height: 56px;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- „É¢„Éº„ÉÄ„É´È¢®„Éö„Éº„Ç∏ -->
    <div class="spot-detail-page">
        <div class="spot-detail-container">
            <!-- „Éò„ÉÉ„ÉÄ„ÉºÔºà‰∏≠Â§ÆÊèÉ„Åà„Çí‰øÆÊ≠£Ôºâ -->
            <header class="spot-header fixed-height px-4 flex justify-end items-center">
                <button onclick="goBack()" class="back-button text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                    <span class="material-icons p-2">close</span>
                </button>
            </header>
            
            <!-- „Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
            <div class="spot-content">
                <!-- ÂÜôÁúü„Éª„Çπ„Éù„ÉÉ„ÉàÂêç„Ç®„É™„Ç¢ (‰∏Ä‰ΩìÂåñ) -->
                <div class="p-4 border-b border-[var(--border-color)]">
                    <!-- ÂÜôÁúü„ÇÆ„É£„É©„É™„ÉºÔºà„Ç´„É´„Éº„Çª„É´UI„Å´Â§âÊõ¥Ôºâ -->
                    {% if photos and photos|length > 0 %}
                    <div class="photo-gallery-wrapper">
                        <div class="photo-gallery h-[250px] rounded-xl">
                            {% for photo_url in photos %}
                            <img src="{{ photo_url }}" 
                                 alt="{{ spot.name }}"
                                 onerror="this.src='{{ url_for('static', filename='images/default_profile.png') }}'" />
                            {% endfor %}
                        </div>
                        <div class="photo-dots"></div>
                    </div>
                    {% endif %}

                    <!-- „Çπ„Éù„ÉÉ„ÉàÂêç„Çª„ÇØ„Ç∑„Éß„É≥Ôºà‰ΩôÁôΩË™øÊï¥Ôºâ -->
                    <div class="pt-4">
                        <h2 class="text-lg font-bold text-[var(--text-primary)]">{{ spot.name }}</h2>
                        {% if spot.category %}
                        <p class="text-sm text-[var(--text-secondary)] mt-1">
                            <span class="material-icons-outlined text-sm align-middle mr-1">category</span>
                            {{ spot.category }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- „É¶„Éº„Ç∂„Éº„ÅÆÂè£„Ç≥„Éü„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">„É¨„Éì„É•„Éº</h3>
                    <!-- ÊäïÁ®øËÄÖÊÉÖÂ†± -->
                    <div class="flex items-center gap-3 mb-4">
                        <img alt="„É¶„Éº„Ç∂„Éº„Ç¢„Ç§„Ç≥„É≥" class="w-10 h-10 rounded-full flex-shrink-0" 
                             src="{{ url_for('static', filename='images/default_profile.png') if not user.profile_pic_url else user.profile_pic_url }}"/>
                        <div>
                            <p class="font-medium text-[var(--text-primary)]">{{ user.username }}</p>
                        </div>
                    </div>

                    <!-- Êñ∞„Åó„ÅÑË©ï‰æ°„Éá„Ç∂„Ç§„É≥ -->
                    <div class="review-display mb-4">
                        {% if spot.rating %}
                            <div class="review-score">{{ "%.1f"|format(spot.rating) }}</div>
                            <div class="review-stars flex">
                                {% set full_stars = (spot.rating | int) %}
                                {% set has_half_star = (spot.rating - full_stars) >= 0.5 %}
                                {% set empty_stars = 5 - full_stars - (1 if has_half_star else 0) %}
                                
                                {% for i in range(full_stars) %}
                                    <span class="material-icons text-yellow-400">star</span>
                                {% endfor %}
                                
                                {% if has_half_star %}
                                    <span class="material-icons text-yellow-400">star_half</span>
                                {% endif %}
                                
                                {% for i in range(empty_stars) %}
                                    <span class="material-icons text-gray-300">star_border</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-sm text-[var(--text-secondary)]">Ë©ï‰æ°„Å™„Åó</span>
                        {% endif %}
                    </div>

                    <!-- „Éá„Ç£„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥ -->
                    {% if spot.description %}
                    <div class="mb-4">
                        <p class="text-sm text-[var(--text-secondary)] leading-relaxed">{{ spot.description }}</p>
                    </div>
                    {% endif %}

                    <!-- Êñ∞„Åó„ÅÑSNS„ÅÆ„É™„É≥„ÇØ -->
                    {% if social_links %}
                    <div class="mt-4">
                        <h4 class="font-medium text-[var(--text-primary)] mb-2">SNS</h4>
                        <div class="sns-links-container">
                            {% for platform, url in social_links.items() %}
                            <a href="{{ url if url else '#' }}" 
                               target="_blank" rel="noopener noreferrer" 
                               class="sns-link {{ 'sns-link-active' if url else 'sns-link-inactive' }}">
                                <img src="{{ url_for('static', filename='icons/social/' + platform + '.svg') }}" alt="{{ platform|title }}">
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </section>
                
                <!-- „Çπ„Éù„ÉÉ„Éà„ÅÆÂ†¥ÊâÄ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">Â†¥ÊâÄ</h3>
                    <p class="text-sm text-[var(--text-secondary)] mb-3">
                        <span class="material-icons-outlined text-sm align-middle mr-1">location_on</span>
                        {{ spot.summary_location or spot.location }}
                    </p>
                    {% if spot.latitude and spot.longitude %}
                    <div id="spot-map"></div>
                    {% endif %}
                </section>

                <!-- „Åù„ÅÆ‰ªñ„ÅÆ„É™„É≥„ÇØÔºà„ÇÇ„Å£„Å®„Åø„ÇãÔºâ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">„ÇÇ„Å£„Å®Ë¶ã„Çã</h3>
                    
                    <!-- „Ç¢„Éï„Ç£„É™„Ç®„Ç§„Éà„É™„É≥„ÇØ -->
                    {% if spot.affiliate_links %}
                        {% for link in spot.affiliate_links %}
                            {% if link.is_active %}
                                <div class="flex gap-4 items-center py-3 border-b border-[var(--border-color)] last:border-b-0">
                                    {% if link.icon_key %}
                                        <img
                                            src="{{ url_for('static', filename='icons/affiliates/' ~ link.icon_key ~ '.svg') }}"
                                            alt="{{ link.platform }} logo"
                                            class="object-contain shrink-0 w-10 h-10 rounded-lg"
                                            onerror="this.src='/static/images/default_profile.png'"
                                        />
                                    {% else %}
                                        <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center">
                                            <span class="material-icons text-gray-500">link</span>
                                        </div>
                                    {% endif %}
                                    <div class="flex flex-col justify-center flex-1">
                                        <h4 class="text-base font-medium text-[var(--text-primary)]">
                                            {{ link.title or link.platform|title }}
                                        </h4>
                                        <p class="text-sm text-[var(--text-secondary)]">
                                            {{ link.description or 'Ë©≥Á¥∞„ÇíË¶ã„Çã' }}
                                        </p>
                                    </div>
                                    <a href="{{ link.url }}" 
                                       target="_blank" 
                                       class="flex justify-center items-center px-4 py-2 rounded-lg 
                                            {% if link.platform == 'rakuten' %}bg-[#00B900]{% else %}bg-[var(--primary-color)]{% endif %} text-white">
                                        {% if link.platform == 'rakuten' %}‰∫àÁ¥Ñ{% else %}Èñã„Åè{% endif %}
                                    </a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Google Maps Link -->
                    <div class="flex gap-4 items-center py-3">
                        <img
                            src="{{ url_for('static', filename='icons/maps/google-maps.svg') }}"
                            alt="Google Maps logo"
                            class="object-contain shrink-0 w-10 h-10 rounded-lg"
                            onerror="this.src='/static/images/default_profile.png'"
                        />
                        <div class="flex flex-col justify-center flex-1">
                            <h4 class="text-base font-medium text-[var(--text-primary)]">
                                Google Maps
                            </h4>
                            <p class="text-sm text-[var(--text-secondary)]">
                                „É´„Éº„ÉàÊ§úÁ¥¢„ÉªË©≥Á¥∞ÊÉÖÂ†±„ÇíË¶ã„Çã
                            </p>
                        </div>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ spot.name|urlencode }}&query_place_id={{ spot.google_place_id or '' }}" 
                           target="_blank" 
                           class="flex justify-center items-center px-4 py-2 rounded-lg bg-[var(--primary-color)] text-white">
                            Èñã„Åè
                        </a>
                    </div>
                </section>
                
                <!-- ‰∏ãÈÉ®‰ΩôÁôΩ -->
                <div class="h-32"></div>
            </div>
        </div>
    </div>

    <!-- „Éï„ÉÉ„Çø„ÉºÔºà„Éó„É≠„Éï„Ç£„Éº„É´„Éö„Éº„Ç∏„Å®Âêå„Åò„Éë„Çø„Éº„É≥Ôºâ -->
    <footer class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-[var(--background-color)] border-t border-[var(--border-color)] px-2 py-3 shadow-top">
        <div class="w-full">
            <div id="agent-quick-prompts" class="mb-2.5 flex space-x-2 overflow-x-auto scrollbar-hide">
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="„Åì„ÅÆ„Çπ„Éù„ÉÉ„Éà„Å´„Å§„ÅÑ„Å¶Êïô„Åà„Å¶">Ë©≥Á¥∞„ÇíËÅû„Åè</button>
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="Ëøë„Åè„ÅÆ„Åä„Åô„Åô„ÇÅ„Çπ„Éù„ÉÉ„Éà„ÅØÔºü">Âë®Ëæ∫„Çπ„Éù„ÉÉ„Éà</button>
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="„Ç¢„ÇØ„Çª„ÇπÊñπÊ≥ï„ÇíÊïô„Åà„Å¶">„Ç¢„ÇØ„Çª„ÇπÊñπÊ≥ï</button>
            </div>
            <div class="flex items-center space-x-2">
                <input id="footer-user-input" class="flex-1 min-w-0 py-2.5 px-3.5 border border-gray-300 rounded-full focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none text-base text-[var(--text-primary)] placeholder-[var(--text-secondary)] bg-white" placeholder="Ë≥™Âïè„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜ" type="text"/>
                <button id="footer-send-message" class="w-10 h-10 bg-[var(--primary-color)] text-white rounded-full hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-lg text-white">arrow_upward</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- AI Assistant Modal -->
    {% include 'includes/_agent_modal.html' %}

    <!-- ÂøÖË¶Å„Å™JavaScript„É©„Ç§„Éñ„É©„É™ -->
    <!-- Êñ∞„Åó„ÅÑ„Ç®„Éº„Ç∏„Çß„É≥„Éà„Ç∑„Çπ„ÉÜ„É†„ÅÆCSS & JS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/agent-chat.css') }}">
    <script src="{{ url_for('static', filename='js/agent-chat.js') }}"></script>
    
    <script>
        // Êàª„ÇãÊ©üËÉΩÔºàFOUCÈò≤Ê≠¢„ÇíÈÅ©Áî®„Åó„ÅüÈñâ„Åò„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ôºâ
        function goBack() {
            const container = document.querySelector('.spot-detail-container');
            
            // 1. „Çπ„É©„Ç§„Éâ„Ç¢„Ç¶„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            container.classList.add('animate-out');
            
            // 2. „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´„Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÈùûË°®Á§∫
            setTimeout(() => {
                // „Éö„Éº„Ç∏ÂÖ®‰Ωì„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶„Åã„Çâ„Éö„Éº„Ç∏ÈÅ∑Áßª
                document.documentElement.classList.add('no-fouc');
                
                // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Éö„Éº„Ç∏ÈÅ∑ÁßªÔºàË¶ñË¶öÁöÑ„Å™ÂÆå‰∫ÜÊÑüÔºâ
                setTimeout(() => {
                    // „É™„Éï„Ç°„É©„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶ÈÅ©Âàá„Å™Êàª„ÇäÂÖà„ÇíÊ±∫ÂÆö
                    const referrer = document.referrer;
                    const currentDomain = window.location.origin;
                    
                    if (referrer && referrer.startsWith(currentDomain)) {
                        // Âêå‰∏Ä„Éâ„É°„Ç§„É≥„Åã„Çâ„ÅÆÈÅ∑Áßª„ÅÆÂ†¥Âêà„ÅØÂ±•Ê≠¥„Çí‰ΩøÁî®
                        if (window.history.length > 1) {
                            window.history.back();
                            return;
                        }
                        
                        // „É™„Éï„Ç°„É©„Éº„Ååmap„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà
                        if (referrer.includes('/map')) {
                            const mapUrl = referrer;
                            window.location.href = mapUrl;
                            return;
                        }
                        
                        // „É™„Éï„Ç°„É©„Éº„Åå„Éó„É≠„Éï„Ç£„Éº„É´„Éö„Éº„Ç∏„ÅÆÂ†¥Âêà
                        if (referrer.match(/\/[^\/]+\/?$/)) {
                            window.location.href = referrer;
                            return;
                        }
                    }
                    
                    // „Éá„Éï„Ç©„É´„Éà„ÅØ„Éó„É≠„Éï„Ç£„Éº„É´„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
                    window.location.href = '/{{ user.display_name or user.username }}';
                }, 50);
            }, 350); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì„Çà„ÇäÂ∞ë„ÅóÊó©„Åè
        }
        
        // ESC„Ç≠„Éº„ÅßÊàª„ÇãÔºàÂêå„ÅòÈñâ„Åò„ÇãÂá¶ÁêÜ„Çí‰ΩøÁî®Ôºâ
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                goBack();
            }
        });
        
        // FOUCÈò≤Ê≠¢„ÅÆÂÆüË£Ö
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Spot detail page loaded');
            
            const container = document.querySelector('.spot-detail-container');
            
            // FOUCÈò≤Ê≠¢Ôºö„Éö„Éº„Ç∏Ë°®Á§∫„Å®„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            document.documentElement.classList.remove('no-fouc');
            
            // Ê¨°„ÅÆ„Éï„É¨„Éº„É†„Åß„Çπ„É©„Ç§„Éâ„Ç§„É≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            requestAnimationFrame(() => {
                container.classList.add('animate-in');
            });
            
            // Âú∞Âõ≥„ÅÆÂàùÊúüÂåñ
            {% if spot.latitude and spot.longitude %}
            initializeMap();
            {% endif %}
            
            // bioË°®Á§∫Âà∂Âæ°„ÅÆÂàùÊúüÂåñ
            initializeBioToggle();
            
            // ÂÜôÁúü„Ç´„É´„Éº„Çª„É´„ÅÆÂàùÊúüÂåñ
            initializePhotoCarousel();

            // AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„ÅÆÂàùÊúüÂåñ
            initializeAIAssistant();
        });

        // BioË°®Á§∫Âà∂Âæ°„ÅÆÂàùÊúüÂåñÔºà„Éó„É≠„Éï„Ç£„Éº„É´„Éö„Éº„Ç∏„Åã„ÇâÁßªÊ§çÔºâ
        function initializeBioToggle() {
            const bioText = document.getElementById('owner-bio-text');
            const bioToggle = document.getElementById('owner-bio-toggle');
            
            if (!bioText || !bioToggle) return;
            
            const checkBioOverflow = () => {
                bioText.classList.add('bio-collapsed');
                
                const lineHeight = parseFloat(window.getComputedStyle(bioText).lineHeight);
                const maxHeight = lineHeight * 2;
                
                if (bioText.scrollHeight > maxHeight) {
                    bioToggle.style.display = 'inline-block';
                    bioToggle.textContent = '„ÇÇ„Å£„Å®„Åø„Çã';
                    bioToggle.onclick = () => {
                        if (bioText.classList.contains('bio-collapsed')) {
                            bioText.classList.remove('bio-collapsed');
                            bioText.classList.add('bio-expanded');
                            bioToggle.textContent = 'Èñâ„Åò„Çã';
                        } else {
                            bioText.classList.remove('bio-expanded');
                            bioText.classList.add('bio-collapsed');
                            bioToggle.textContent = '„ÇÇ„Å£„Å®„Åø„Çã';
                        }
                    };
                } else {
                    bioToggle.style.display = 'none';
                }
            };
            
            checkBioOverflow();
        }
        
        // Âú∞Âõ≥ÂàùÊúüÂåñÈñ¢Êï∞
        {% if spot.latitude and spot.longitude %}
        function initializeMap() {
            const lat = {{ spot.latitude }};
            const lng = {{ spot.longitude }};
            const spotName = '{{ spot.name|replace("'", "\\'") }}';
            
            const map = L.map('spot-map').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            L.marker([lat, lng])
                .addTo(map)
                .bindPopup(spotName)
                .openPopup();
            
            // Âú∞Âõ≥„ÅÆ„Çµ„Ç§„Ç∫Êõ¥Êñ∞
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        {% endif %}
        
        // ÂÜôÁúü„Ç´„É´„Éº„Çª„É´ÂàùÊúüÂåñÈñ¢Êï∞
        function initializePhotoCarousel() {
            const wrapper = document.querySelector('.photo-gallery-wrapper');
            if (!wrapper) return;

            const gallery = wrapper.querySelector('.photo-gallery');
            const dotsContainer = wrapper.querySelector('.photo-dots');
            const photos = gallery.querySelectorAll('img');

            if (photos.length < 2) {
                if(dotsContainer) dotsContainer.style.display = 'none';
                return;
            }

            // „Éâ„ÉÉ„Éà„ÇíÁîüÊàê
            dotsContainer.innerHTML = ''; // Êó¢Â≠ò„ÅÆ„Éâ„ÉÉ„Éà„Çí„ÇØ„É™„Ç¢
            photos.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.classList.add('dot');
                if (index === 0) dot.classList.add('active');
                dotsContainer.appendChild(dot);
            });

            const dots = dotsContainer.querySelectorAll('.dot');

            // „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà„ÅÆ„Éè„É≥„Éâ„É© (gap„ÇíËÄÉÊÖÆ)
            const handleScroll = () => {
                const photoWidth = gallery.offsetWidth;
                const gap = parseFloat(window.getComputedStyle(gallery).gap) || 0;
                const currentIndex = Math.round(gallery.scrollLeft / (photoWidth + gap));

                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
            };

            // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÅÆ„Åü„ÇÅ„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
            let scrollTimeout;
            gallery.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(handleScroll, 50);
            });
        }
        
        // AI„Ç¢„Ç∑„Çπ„Çø„É≥„ÉàÂàùÊúüÂåñÔºàÊñ∞„Åó„ÅÑ„Ç∑„Çπ„ÉÜ„É†Ôºâ
        function initializeAIAssistant() {
            console.log('üîÑ Initializing new agent system for spot detail...');
            
            if (typeof AgentChat === 'undefined') {
                console.error('‚ùå AgentChat is not defined');
                return;
            }
            
            try {
                // „Çπ„Éù„ÉÉ„ÉàË©≥Á¥∞„Éö„Éº„Ç∏Áî®„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÉÅ„É£„ÉÉ„Éà„ÇíÂàùÊúüÂåñ
                const agentChat = new AgentChat('chat-messages', {
                    contextType: 'spot_detail',
                    influencerId: parseInt('{{ user.id }}'),
                    spotId: parseInt('{{ spot.id }}'),
                    apiVersion: 'v3'
                });
                
                console.log('‚úÖ AgentChat initialized for spot detail page');
            } catch (error) {
                console.error('‚ùå Error initializing AgentChat:', error);
            }
        }
    </script>
</body>
</html> 