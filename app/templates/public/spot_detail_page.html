<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-8YNG8DGYKZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-8YNG8DGYKZ');
    </script>
    
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    
    <!-- å‹•çš„ãƒ¡ã‚¿ã‚¿ã‚°è¨­å®š -->
    <meta name="description" content="{{ spot.description or (spot.name + 'ã®è©³ç´°æƒ…å ±') }}">
    <title>{{ spot.name }} | {{ user.username }} | maplink</title>
    
    <!-- OGPè¨­å®š -->
    <meta property="og:title" content="{{ spot.name }} | {{ user.username }}">
    <meta property="og:description" content="{{ spot.description or (spot.name + ' - ' + (spot.location or '')) }}">
    {% if photos and photos|length > 0 %}
    <meta property="og:image" content="{{ photos[0] }}">
    {% else %}
    <meta property="og:image" content="{{ url_for('static', filename='images/ogp.png', _external=True) }}">
    {% endif %}
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">
    
    <!-- Twitter Cardè¨­å®š -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ spot.name }} | {{ user.username }}">
    <meta name="twitter:description" content="{{ spot.description or (spot.name + ' - ' + (spot.location or '')) }}">
    {% if photos and photos|length > 0 %}
    <meta name="twitter:image" content="{{ photos[0] }}">
    {% else %}
    <meta name="twitter:image" content="{{ url_for('static', filename='images/ogp.png', _external=True) }}">
    {% endif %}
    
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon_32x32.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å€‹åˆ¥èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    
    <!-- marked.js ã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- FOUCé˜²æ­¢ï¼šã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§å³åº§ã«éè¡¨ç¤º -->
    <style>
        .no-fouc { display: none; }
    </style>
    <script>
        document.documentElement.className = 'no-fouc';
    </script>
    
    <style type="text/tailwindcss">
        :root {
          --primary-color: #2563EB;
          --secondary-color: #F3F4F6;
          --accent-color: #F59E0B;
          --text-primary: #111827;
          --text-secondary: #4B5563;
          --background-color: #FFFFFF;
          --card-background: #F9FAFB;
          --border-color: #E5E7EB;
          --hover-bg-color: #EFF6FF;
        }
        
        body {
          font-family: 'Noto Sans JP', sans-serif;
          margin: 0;
          padding: 0;
          background: #F8F9FA;
        }
        
        /* é€šå¸¸ã®ãƒšãƒ¼ã‚¸è¡¨ç¤º */
        .spot-detail-page {
            min-height: 100vh;
            width: 100%;
            background: #F8F9FA;
        }
        
        .spot-detail-container {
            width: 100%;
            max-width: 28rem;
            min-height: 100vh;
            margin: 0 auto;
            background: var(--background-color);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .spot-detail-container.animate-in {
            transform: translateY(0);
        }
        
        .spot-detail-container.animate-out {
            transform: translateY(100%);
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®š */
        .spot-header {
            position: relative;
            z-index: 10;
            background: var(--background-color);
            /* border-bottom ã¯æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã§ç®¡ç† */
        }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã‚¨ãƒªã‚¢ */
        .spot-content {
            flex: 1;
            overflow-y: auto;
            background: var(--background-color);
        }
        
        /* åœ°å›³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #spot-map {
            width: 100%;
            height: 250px;
            border-radius: 0.75rem;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .back-button {
            transition: transform 0.2s ease;
        }
        
        .back-button:hover {
            transform: scale(1.1);
        }
        
        /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        /* å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ */
        .photo-gallery {
            display: flex;
            gap: 0.5rem; /* å†™çœŸé–“ã®éš™é–“ã‚’è¿½åŠ  (8px) */
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            scroll-snap-type: x mandatory; /* æ¨ªæ–¹å‘ã®ã‚¹ãƒŠãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        }
        .photo-gallery::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        
        .photo-gallery img {
            width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã®å¹…ã„ã£ã±ã„ã«è¡¨ç¤º */
            height: 100%;
            object-fit: cover;
            flex-shrink: 0;
            border-radius: 0.75rem; /* è§’ä¸¸ã‚’é©ç”¨ */
            scroll-snap-align: start; /* å„ç”»åƒã®å…ˆé ­ã§ã‚¹ãƒŠãƒƒãƒ— */
        }
        
        /* --- ã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã®ãƒ‰ãƒƒãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ --- */
        .photo-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--border-color);
            transition: background-color 0.2s ease;
        }
        .dot.active {
            background-color: var(--primary-color);
        }
        
        /* ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .review-display {
            display: flex;
            flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
            align-items: flex-start; /* å·¦æƒãˆã«å¤‰æ›´ */
            gap: 0.25rem; /* 4px */
        }
        .review-score {
            font-size: 2.25rem; /* 36px */
            line-height: 2.5rem; /* 40px */
            font-weight: 700;
        }
        .review-stars .material-icons {
            font-size: 1.25rem; /* 20px */
        }

        /* --- SNSãƒªãƒ³ã‚¯ã®æ–°ã—ã„ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .sns-links-container {
            display: flex;
            gap: 1rem; /* 16px */
        }
        .sns-link {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 44px;
            height: 44px;
            transition: all 0.2s ease;
        }
        .sns-link-active:hover {
            transform: scale(1.1);
        }
        .sns-link-active img {
            width: 28px;
            height: 28px;
        }
        .sns-link-inactive {
            background-color: #F3F4F6; /* è–„ã„ã‚°ãƒ¬ãƒ¼ã®èƒŒæ™¯ */
            border-radius: 50%;
            cursor: default;
        }
        .sns-link-inactive img {
            width: 24px;
            height: 24px;
            filter: grayscale(100%);
            opacity: 0.6; /* é€æ˜åº¦ã‚’å°‘ã—ä¸Šã’ã‚‹ */
        }

        /* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªSNSãƒªãƒ³ã‚¯ */
        .sns-link-inactive {
            filter: grayscale(100%);
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* ã‚¯ã‚¤ãƒƒã‚¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒœã‚¿ãƒ³ */
        
        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        
        .shadow-top {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Bioè¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‹ã‚‰è¿½åŠ ï¼‰ */
        .bio-collapsed {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }
        .bio-expanded {
            line-height: 1.4;
        }
        .bio-toggle-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        /* --- æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .spot-header.fixed-height {
            height: 56px;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«é¢¨ãƒšãƒ¼ã‚¸ -->
    <div class="spot-detail-page">
        <div class="spot-detail-container">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¸­å¤®æƒãˆã‚’ä¿®æ­£ï¼‰ -->
            <header class="spot-header fixed-height px-4 flex justify-end items-center">
                <button onclick="goBack()" class="back-button text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                    <span class="material-icons p-2">close</span>
                </button>
            </header>
            
            <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="spot-content">
                <!-- å†™çœŸãƒ»ã‚¹ãƒãƒƒãƒˆåã‚¨ãƒªã‚¢ (ä¸€ä½“åŒ–) -->
                <div class="p-4 border-b border-[var(--border-color)]">
                    <!-- å†™çœŸã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆã‚«ãƒ«ãƒ¼ã‚»ãƒ«UIã«å¤‰æ›´ï¼‰ -->
                    {% if photos and photos|length > 0 %}
                    <div class="photo-gallery-wrapper">
                        <div class="photo-gallery h-[250px] rounded-xl">
                            {% for photo_url in photos %}
                            <img src="{{ photo_url }}" 
                                 alt="{{ spot.name }}"
                                 onerror="this.src='{{ url_for('static', filename='images/default_profile.png') }}'" />
                            {% endfor %}
                        </div>
                        <div class="photo-dots"></div>
                    </div>
                    {% endif %}

                    <!-- ã‚¹ãƒãƒƒãƒˆåã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä½™ç™½èª¿æ•´ï¼‰ -->
                    <div class="pt-4">
                        <h2 class="text-lg font-bold text-[var(--text-primary)]">{{ spot.name }}</h2>
                        {% if spot.category %}
                        <p class="text-sm text-[var(--text-secondary)] mt-1">
                            <span class="material-icons-outlined text-sm align-middle mr-1">category</span>
                            {{ spot.category }}
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£ã‚³ãƒŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                    <!-- æŠ•ç¨¿è€…æƒ…å ± -->
                    <div class="flex items-center gap-3 mb-4">
                        <img alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³" class="w-10 h-10 rounded-full flex-shrink-0" 
                             src="{{ url_for('static', filename='images/default_profile.png') if not user.profile_pic_url else user.profile_pic_url }}"/>
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-[var(--text-primary)] truncate">{{ user.username }}</p>
                        </div>
                    </div>

                    <!-- æ–°ã—ã„è©•ä¾¡ãƒ‡ã‚¶ã‚¤ãƒ³ -->
                    <div class="review-display mb-4">
                        {% if spot.rating %}
                            <div class="review-score">{{ "%.1f"|format(spot.rating) }}</div>
                            <div class="review-stars flex">
                                {% set full_stars = (spot.rating | int) %}
                                {% set has_half_star = (spot.rating - full_stars) >= 0.5 %}
                                {% set empty_stars = 5 - full_stars - (1 if has_half_star else 0) %}
                                
                                {% for i in range(full_stars) %}
                                    <span class="material-icons text-yellow-400">star</span>
                                {% endfor %}
                                
                                {% if has_half_star %}
                                    <span class="material-icons text-yellow-400">star_half</span>
                                {% endif %}
                                
                                {% for i in range(empty_stars) %}
                                    <span class="material-icons text-gray-300">star_border</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <span class="text-sm text-[var(--text-secondary)]">è©•ä¾¡ãªã—</span>
                        {% endif %}
                    </div>

                    <!-- ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ -->
                    {% if spot.description %}
                    <div class="mb-4">
                        <p class="text-sm text-[var(--text-secondary)] leading-relaxed">{{ spot.description }}</p>
                    </div>
                    {% endif %}

                    <!-- æ–°ã—ã„SNSã®ãƒªãƒ³ã‚¯ -->
                    {% if social_links %}
                    <div class="mt-4">
                        <h4 class="font-medium text-[var(--text-primary)] mb-2">SNS</h4>
                        <div class="sns-links-container">
                            {% for platform, url in social_links.items() %}
                            <a href="{{ url if url else '#' }}" 
                               target="_blank" rel="noopener noreferrer" 
                               class="sns-link {{ 'sns-link-active' if url else 'sns-link-inactive' }}">
                                <img src="{{ url_for('static', filename='icons/social/' + platform + '.svg') }}" alt="{{ platform|title }}">
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </section>
                
                <!-- ã‚¹ãƒãƒƒãƒˆã®å ´æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">å ´æ‰€</h3>
                    <p class="text-sm text-[var(--text-secondary)] mb-3">
                        <span class="material-icons-outlined text-sm align-middle mr-1">location_on</span>
                        {{ spot.summary_location or spot.location }}
                    </p>
                    {% if spot.latitude and spot.longitude %}
                    <div id="spot-map"></div>
                    {% endif %}
                </section>

                <!-- ãã®ä»–ã®ãƒªãƒ³ã‚¯ï¼ˆã‚‚ã£ã¨ã¿ã‚‹ï¼‰ -->
                <section class="section">
                    <h3 class="font-semibold text-[var(--text-primary)] mb-3">ã‚‚ã£ã¨è¦‹ã‚‹</h3>
                    
                    <!-- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆãƒªãƒ³ã‚¯ -->
                    {% if spot.affiliate_links %}
                        {% for link in spot.affiliate_links %}
                            {% if link.is_active %}
                                <div class="flex gap-4 items-center py-3 border-b border-[var(--border-color)] last:border-b-0">
                                    {% if link.icon_key %}
                                        <img
                                            src="{{ url_for('static', filename='icons/affiliates/' ~ link.icon_key ~ '.svg') }}"
                                            alt="{{ link.platform }} logo"
                                            class="object-contain shrink-0 w-10 h-10 rounded-lg"
                                            onerror="this.src='/static/images/default_profile.png'"
                                        />
                                    {% else %}
                                        <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center">
                                            <span class="material-icons text-gray-500">link</span>
                                        </div>
                                    {% endif %}
                                    <div class="flex flex-col justify-center flex-1">
                                        <h4 class="text-base font-medium text-[var(--text-primary)]">
                                            {{ link.title or link.platform|title }}
                                        </h4>
                                        <p class="text-sm text-[var(--text-secondary)]">
                                            {{ link.description or 'è©³ç´°ã‚’è¦‹ã‚‹' }}
                                        </p>
                                    </div>
                                    <a href="{{ link.url }}" 
                                       target="_blank" 
                                       class="flex justify-center items-center px-4 py-2 rounded-lg 
                                            {% if link.platform == 'rakuten' %}bg-[#00B900]{% else %}bg-[var(--primary-color)]{% endif %} text-white">
                                        {% if link.platform == 'rakuten' %}äºˆç´„{% else %}é–‹ã{% endif %}
                                    </a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Google Maps Link -->
                    <div class="flex gap-4 items-center py-3">
                        <img
                            src="{{ url_for('static', filename='icons/maps/google-maps.svg') }}"
                            alt="Google Maps logo"
                            class="object-contain shrink-0 w-10 h-10 rounded-lg"
                            onerror="this.src='/static/images/default_profile.png'"
                        />
                        <div class="flex flex-col justify-center flex-1">
                            <h4 class="text-base font-medium text-[var(--text-primary)]">
                                Google Maps
                            </h4>
                            <p class="text-sm text-[var(--text-secondary)]">
                                ãƒ«ãƒ¼ãƒˆæ¤œç´¢ãƒ»è©³ç´°æƒ…å ±ã‚’è¦‹ã‚‹
                            </p>
                        </div>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ spot.name|urlencode }}&query_place_id={{ spot.google_place_id or '' }}" 
                           target="_blank" 
                           class="flex justify-center items-center px-4 py-2 rounded-lg bg-[var(--primary-color)] text-white">
                            é–‹ã
                        </a>
                    </div>
                </section>
                
                <!-- ä¸‹éƒ¨ä½™ç™½ -->
                <div class="h-32"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ -->
    <footer class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-[var(--background-color)] border-t border-[var(--border-color)] px-2 py-3 shadow-top">
        <div class="w-full">
            <div id="agent-quick-prompts" class="mb-2.5 flex space-x-2 overflow-x-auto scrollbar-hide">
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="ã“ã®ã‚¹ãƒãƒƒãƒˆã«ã¤ã„ã¦æ•™ãˆã¦">è©³ç´°ã‚’èã</button>
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="è¿‘ãã®ãŠã™ã™ã‚ã‚¹ãƒãƒƒãƒˆã¯ï¼Ÿ">å‘¨è¾ºã‚¹ãƒãƒƒãƒˆ</button>
                <button class="px-3 py-1.5 rounded-full border border-[var(--primary-color)] text-[var(--primary-color)] text-xs font-medium hover:bg-[var(--hover-bg-color)] whitespace-nowrap transition-colors duration-150" data-prompt="ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã‚’æ•™ãˆã¦">ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</button>
            </div>
            <div class="flex items-center space-x-2">
                <input id="footer-user-input" class="flex-1 min-w-0 py-2.5 px-3.5 border border-gray-300 rounded-full focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent outline-none text-base text-[var(--text-primary)] placeholder-[var(--text-secondary)] bg-white" placeholder="è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†" type="text"/>
                <button id="footer-send-message" class="w-10 h-10 bg-[var(--primary-color)] text-white rounded-full hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center flex-shrink-0">
                    <span class="material-icons text-lg text-white">arrow_upward</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- AI Assistant Modal -->
    {% include 'includes/_agent_modal.html' %}

    <!-- å¿…è¦ãªJavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <!-- æ–°ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®CSS & JS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/agent-chat.css') }}">
    <script src="{{ url_for('static', filename='js/agent-chat.js') }}"></script>
    
    <script>
        // æˆ»ã‚‹æ©Ÿèƒ½ï¼ˆFOUCé˜²æ­¢ã‚’é©ç”¨ã—ãŸé–‰ã˜ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        function goBack() {
            const container = document.querySelector('.spot-detail-container');
            
            // 1. ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            container.classList.add('animate-out');
            
            // 2. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’éè¡¨ç¤º
            setTimeout(() => {
                // ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’éè¡¨ç¤ºã«ã—ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸é·ç§»
                document.documentElement.classList.add('no-fouc');
                
                // å°‘ã—é…å»¶ã—ã¦ãƒšãƒ¼ã‚¸é·ç§»ï¼ˆè¦–è¦šçš„ãªå®Œäº†æ„Ÿï¼‰
                setTimeout(() => {
                    // ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦é©åˆ‡ãªæˆ»ã‚Šå…ˆã‚’æ±ºå®š
                    const referrer = document.referrer;
                    const currentDomain = window.location.origin;
                    
                    if (referrer && referrer.startsWith(currentDomain)) {
                        // åŒä¸€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®é·ç§»ã®å ´åˆã¯å±¥æ­´ã‚’ä½¿ç”¨
                        if (window.history.length > 1) {
                            window.history.back();
                            return;
                        }
                        
                        // ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãŒmapãƒšãƒ¼ã‚¸ã®å ´åˆ
                        if (referrer.includes('/map')) {
                            const mapUrl = referrer;
                            window.location.href = mapUrl;
                            return;
                        }
                        
                        // ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãŒãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®å ´åˆ
                        if (referrer.match(/\/[^\/]+\/?$/)) {
                            window.location.href = referrer;
                            return;
                        }
                    }
                    
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = '/{{ user.display_name or user.username }}';
                }, 50);
            }, 350); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚ˆã‚Šå°‘ã—æ—©ã
        }
        
        // ESCã‚­ãƒ¼ã§æˆ»ã‚‹ï¼ˆåŒã˜é–‰ã˜ã‚‹å‡¦ç†ã‚’ä½¿ç”¨ï¼‰
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                goBack();
            }
        });
        
        // FOUCé˜²æ­¢ã®å®Ÿè£…
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Spot detail page loaded');
            
            const container = document.querySelector('.spot-detail-container');
            
            // FOUCé˜²æ­¢ï¼šãƒšãƒ¼ã‚¸è¡¨ç¤ºã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            document.documentElement.classList.remove('no-fouc');
            
            // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            requestAnimationFrame(() => {
                container.classList.add('animate-in');
            });
            
            // åœ°å›³ã®åˆæœŸåŒ–
            {% if spot.latitude and spot.longitude %}
            initializeMap();
            {% endif %}
            
            // bioè¡¨ç¤ºåˆ¶å¾¡ã®åˆæœŸåŒ–
            initializeBioToggle();
            
            // å†™çœŸã‚«ãƒ«ãƒ¼ã‚»ãƒ«ã®åˆæœŸåŒ–
            initializePhotoCarousel();

            // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã®åˆæœŸåŒ–
            initializeAIAssistant();
        });

        // Bioè¡¨ç¤ºåˆ¶å¾¡ã®åˆæœŸåŒ–ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‹ã‚‰ç§»æ¤ï¼‰
        function initializeBioToggle() {
            const bioText = document.getElementById('owner-bio-text');
            const bioToggle = document.getElementById('owner-bio-toggle');
            
            if (!bioText || !bioToggle) return;
            
            const checkBioOverflow = () => {
                bioText.classList.add('bio-collapsed');
                
                const lineHeight = parseFloat(window.getComputedStyle(bioText).lineHeight);
                const maxHeight = lineHeight * 2;
                
                if (bioText.scrollHeight > maxHeight) {
                    bioToggle.style.display = 'inline-block';
                    bioToggle.textContent = 'ã‚‚ã£ã¨ã¿ã‚‹';
                    bioToggle.onclick = () => {
                        if (bioText.classList.contains('bio-collapsed')) {
                            bioText.classList.remove('bio-collapsed');
                            bioText.classList.add('bio-expanded');
                            bioToggle.textContent = 'é–‰ã˜ã‚‹';
                        } else {
                            bioText.classList.remove('bio-expanded');
                            bioText.classList.add('bio-collapsed');
                            bioToggle.textContent = 'ã‚‚ã£ã¨ã¿ã‚‹';
                        }
                    };
                } else {
                    bioToggle.style.display = 'none';
                }
            };
            
            checkBioOverflow();
        }
        
        // åœ°å›³åˆæœŸåŒ–é–¢æ•°
        {% if spot.latitude and spot.longitude %}
        function initializeMap() {
            const lat = {{ spot.latitude }};
            const lng = {{ spot.longitude }};
            const spotName = '{{ spot.name|replace("'", "\\'") }}';
            
            const map = L.map('spot-map').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            L.marker([lat, lng])
                .addTo(map)
                .bindPopup(spotName)
                .openPopup();
            
            // åœ°å›³ã®ã‚µã‚¤ã‚ºæ›´æ–°
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }
        {% endif %}
        
        // å†™çœŸã‚«ãƒ«ãƒ¼ã‚»ãƒ«åˆæœŸåŒ–é–¢æ•°
        function initializePhotoCarousel() {
            const wrapper = document.querySelector('.photo-gallery-wrapper');
            if (!wrapper) return;

            const gallery = wrapper.querySelector('.photo-gallery');
            const dotsContainer = wrapper.querySelector('.photo-dots');
            const photos = gallery.querySelectorAll('img');

            if (photos.length < 2) {
                if(dotsContainer) dotsContainer.style.display = 'none';
                return;
            }

            // ãƒ‰ãƒƒãƒˆã‚’ç”Ÿæˆ
            dotsContainer.innerHTML = ''; // æ—¢å­˜ã®ãƒ‰ãƒƒãƒˆã‚’ã‚¯ãƒªã‚¢
            photos.forEach((_, index) => {
                const dot = document.createElement('span');
                dot.classList.add('dot');
                if (index === 0) dot.classList.add('active');
                dotsContainer.appendChild(dot);
            });

            const dots = dotsContainer.querySelectorAll('.dot');

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒãƒ³ãƒ‰ãƒ© (gapã‚’è€ƒæ…®)
            const handleScroll = () => {
                const photoWidth = gallery.offsetWidth;
                const gap = parseFloat(window.getComputedStyle(gallery).gap) || 0;
                const currentIndex = Math.round(gallery.scrollLeft / (photoWidth + gap));

                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentIndex);
                });
            };

            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
            let scrollTimeout;
            gallery.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(handleScroll, 50);
            });
        }
        
        // AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆæ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ï¼‰
        function initializeAIAssistant() {
            console.log('ğŸ”„ Initializing new agent system for spot detail...');
            
            if (typeof AgentChat === 'undefined') {
                console.error('âŒ AgentChat is not defined');
                return;
            }
            
            try {
                // ã‚¹ãƒãƒƒãƒˆè©³ç´°ãƒšãƒ¼ã‚¸ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ£ãƒƒãƒˆã‚’åˆæœŸåŒ–
                const agentChat = new AgentChat('chat-messages', {
                    contextType: 'spot_detail',
                    influencerId: parseInt('{{ user.id }}'),
                    spotId: parseInt('{{ spot.id }}'),
                    apiVersion: 'v3'
                });
                
                console.log('âœ… AgentChat initialized for spot detail page');
            } catch (error) {
                console.error('âŒ Error initializing AgentChat:', error);
            }
        }
    </script>
</body>
</html> 